!function(I){I.imageArea=function(t,i){function o(){t.blurAll(),b.z=100,$()}function s(e){m.trigger(e,[b.id,t.areas()])}function n(e){var t=e||window.event||{};t.cancelBubble=!0,t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()}function a(){u.css({cursor:"default",width:b.width,height:b.height,left:b.x,top:b.y,"z-index":b.z}),g.css({backgroundPosition:-b.x-1+"px "+(-b.y-1)+"px",cursor:f.allowMove?"move":"default",width:0<b.width-2?b.width-2:0,height:0<b.height-2?b.height-2:0,left:b.x+1,top:b.y+1,"z-index":b.z+2})}function r(e){f.allowResize&&(e?I.each(y,function(e,t){var i,a,o=Math.round(t.width()/2),s=Math.round(t.height()/2),n=e[0],r=e[e.length-1];i="n"===n?-s:"s"===n?b.height-s-1:Math.round(b.height/2)-s-1,a="e"===r?b.width-o-1:"w"===r?-o:Math.round(b.width/2)-o-1,t.css({display:"block",left:b.x+a,top:b.y+i,"z-index":b.z+1})}):I(".select-areas-resize-handler").each(function(){I(this).css({display:"none"})}))}function h(e){p&&p.css({display:e?"block":"none",left:b.x+b.width+1,top:b.y-p.outerHeight()-1,"z-index":b.z+1})}function c(e){u.css({cursor:e}),g.css({cursor:e})}function e(e){n(e),o(),z("move",M),z("stop",R);var t=D(e);A[0]=t[0]-b.x,A[1]=t[1]-b.y,$("pickSelection")}function l(e){n(e),o();var t=e.target.className.split(" ")[1];"w"===t[t.length-1]&&(x[0]+=b.width,b.x=x[0]-b.width),"n"===t[0]&&(x[1]+=b.height,b.y=x[1]-b.height),"n"===t||"s"===t?v=!1:"e"!==t&&"w"!==t||(S=!1),z("move",_),z("stop",R),$("pickResizeHandler")}function d(e){n(e),g.remove(),u.remove(),I.each(y,function(e,t){t.remove()}),p.remove(),t._remove(i),s("changed"),s("deleted")}var u,g,p,f=t.options,m=t.$image,w=t.$trigger,y={},v=!0,S=!0,A=[0,0],x=[0,0],b={id:i,x:0,y:0,z:0,height:0,width:0},z=function(e,t){var i,a;switch(e){case"start":i="mousedown",a="touchstart";break;case"move":i="mousemove",a="touchmove";break;case"stop":i="mouseup",a="touchend";break;default:return}t&&jQuery.isFunction(t)?I(window.document).on(i,t).on(a,t):I(window.document).off(i).off(a)},$=function(e){switch(e){case"startSelection":t._refresh(),a(),r(),h(!0);break;case"pickSelection":case"pickResizeHandler":r();break;case"resizeSelection":a(),r(),c("crosshair"),h(!0);break;case"moveSelection":a(),r(),c("move"),h(!0);break;case"blur":a(),r(),h();break;default:a(),r(!0),h(!0)}},_=function(e){n(e),o();var t=D(e),i=t[1]-x[1],a=t[0]-x[0];Math.abs(a)<f.minSize[0]&&(a=0<=a?f.minSize[0]:-f.minSize[0]),Math.abs(i)<f.minSize[1]&&(i=0<=i?f.minSize[1]:-f.minSize[1]),(x[0]+a<0||x[0]+a>m.width())&&(a=-a),(x[1]+i<0||x[1]+i>m.height())&&(i=-i),f.maxSize[0]>f.minSize[0]&&f.maxSize[1]>f.minSize[1]&&(Math.abs(a)>f.maxSize[0]&&(a=0<=a?f.maxSize[0]:-f.maxSize[0]),Math.abs(i)>f.maxSize[1]&&(i=0<=i?f.maxSize[1]:-f.maxSize[1])),v&&(b.width=a),S&&(b.height=i),f.aspectRatio&&(0<a&&0<i||a<0&&i<0?v?i=Math.round(a/f.aspectRatio):a=Math.round(i*f.aspectRatio):v?i=-Math.round(a/f.aspectRatio):a=-Math.round(i*f.aspectRatio),x[0]+a>m.width()&&(a=m.width()-x[0],i=0<i?Math.round(a/f.aspectRatio):-Math.round(a/f.aspectRatio)),x[1]+i<0&&(i=-x[1],a=0<a?-Math.round(i*f.aspectRatio):Math.round(i*f.aspectRatio)),x[1]+i>m.height()&&(i=m.height()-x[1],a=0<a?Math.round(i*f.aspectRatio):-Math.round(i*f.aspectRatio)),b.width=a,b.height=i),b.width<0?(b.width=Math.abs(b.width),b.x=x[0]-b.width):b.x=x[0],b.height<0?(b.height=Math.abs(b.height),b.y=x[1]-b.height):b.y=x[1],s("changing"),$("resizeSelection")},M=function(e){if(n(e),f.allowMove){o();var t=D(e);k({x:t[0]-A[0],y:t[1]-A[1]}),s("changing")}},k=function(e){0<e.x?e.x+b.width<m.width()?b.x=e.x:b.x=m.width()-b.width:b.x=0,0<e.y?e.y+b.height<m.height()?b.y=e.y:b.y=m.height()-b.height:b.y=0,$("moveSelection")},R=function(e){n(e),function(){I.each(arguments,function(e,t){z(t)})}("move","stop"),x[0]=b.x,x[1]=b.y,S=v=!0,s("changed"),$("releaseSelection")},D=function(e){var t=function(e){var t=I(e).offset();return[t.left,t.top]}(m);e.pageX||(e.originalEvent&&(e=e.originalEvent),e.changedTouches&&(e=e.changedTouches[0]),e.touches&&(e=e.touches[0]));var i=e.pageX-t[0],a=e.pageY-t[1];return[i=i<0?0:i>m.width()?m.width():i,a=a<0?0:a>m.height()?m.height():a]};if(u=I('<div class="select-areas-outline" />').css({opacity:f.outlineOpacity,position:"absolute"}).insertAfter(w),g=I("<div />").addClass("select-areas-background-area").css({background:"#fff url("+m.attr("src")+") no-repeat",backgroundSize:m.width()+"px",position:"absolute"}).insertAfter(u),f.allowResize&&I.each(["nw","n","ne","e","se","s","sw","w"],function(e,t){y[t]=I('<div class="select-areas-resize-handler '+t+'"/>').css({opacity:.5,position:"absolute",cursor:t+"-resize"}).insertAfter(g).mousedown(l).bind("touchstart",l)}),f.allowDelete){function C(e){return e.click(d).bind("touchstart",d).bind("tap",d),e}p=C(I('<div class="delete-area" />')).append(C(I('<div class="select-areas-delete-area" />'))).insertAfter(g)}return f.allowMove&&g.mousedown(e).bind("touchstart",e),o(),{getData:function(){return b},startSelection:function(e){n(e),b.width=f.minSize[0],b.height=f.minSize[1],o(),z("move",_),z("stop",R),(x=D(e))[0]+b.width>m.width()&&(x[0]=m.width()-b.width),x[1]+b.height>m.height()&&(x[1]=m.height()-b.height),b.x=x[0],b.y=x[1],$("startSelection")},deleteSelection:d,options:f,blur:function(){b.z=0,$("blur")},focus:o,nudge:function(e){e.x=b.x,e.y=b.y,e.d&&(e.y=b.y+e.d),e.u&&(e.y=b.y-e.u),e.l&&(e.x=b.x-e.l),e.r&&(e.x=b.x+e.r),k(e),s("changed")},set:function(e,t){b=I.extend(b,e),x[0]=b.x,x[1]=b.y,t||s("changed")},contains:function(e){return e.x>=b.x&&e.x<=b.x+b.width&&e.y>=b.y&&e.y<=b.y+b.height}}},I.imageSelectAreas=function(){},I.imageSelectAreas.prototype.init=function(e,t){var o=this;this.options=I.extend({allowEdit:!0,allowMove:!0,allowResize:!0,allowSelect:!0,allowDelete:!0,allowNudge:!0,aspectRatio:0,minSize:[0,0],maxSize:[0,0],width:0,maxAreas:0,outlineOpacity:.5,overlayOpacity:.5,areas:[],onChanging:null,onChanged:null,onDeleted:null},t),this.options.allowEdit||(this.options.allowSelect=this.options.allowMove=this.options.allowResize=this.options.allowDelete=!1),this._areas={},this.$image=I(e),this.ratio=1,this.options.width&&this.$image.width()&&this.options.width!==this.$image.width()&&(this.ratio=this.options.width/this.$image.width(),this.$image.width(this.options.width)),this.options.onChanging&&this.$image.on("changing",this.options.onChanging),this.options.onChanged&&this.$image.on("changed",this.options.onChanged),this.options.onDeleted&&this.$image.on("deleted",this.options.onDeleted),this.options.onLoaded&&this.$image.on("loaded",this.options.onLoaded),this.$holder=I("<div />").css({position:"relative",width:this.$image.width(),height:this.$image.height()}),this.$image.wrap(this.$holder).css({position:"absolute"}),this.$overlay=I('<div class="select-areas-overlay" />').css({opacity:this.options.overlayOpacity,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$image),this.$trigger=I("<div />").css({backgroundColor:"#000000",opacity:0,position:"absolute",width:this.$image.width(),height:this.$image.height()}).insertAfter(this.$overlay),I.each(this.options.areas,function(e,t){o._add(t,!0)}),this.blurAll(),this._refresh(),this.options.allowSelect&&this.$trigger.mousedown(I.proxy(this.newArea,this)).on("touchstart",I.proxy(this.newArea,this)),this.options.allowNudge&&I("html").keydown(function(e){var t,i={37:"l",38:"u",39:"r",40:"d"}[e.which];if(i&&(o._eachArea(function(e){if(100===e.getData().z)return t=e,!1}),t)){var a={};a[i]=1,t.nudge(a)}})},I.imageSelectAreas.prototype._refresh=function(){var e=this.areas().length;this.$overlay.css({display:e?"block":"none"}),e?this.$image.addClass("blurred"):this.$image.removeClass("blurred"),this.$trigger.css({cursor:this.options.allowSelect?"crosshair":"default"})},I.imageSelectAreas.prototype._eachArea=function(i){I.each(this._areas,function(e,t){if(t)return i(t,e)})},I.imageSelectAreas.prototype._remove=function(e){delete this._areas[e],this._refresh()},I.imageSelectAreas.prototype.remove=function(e){this._areas[e]&&this._areas[e].deleteSelection()},I.imageSelectAreas.prototype.newArea=function(e){var i=-1;return this.blurAll(),this.options.maxAreas&&this.options.maxAreas<=this.areas().length||(this._eachArea(function(e,t){i=Math.max(i,parseInt(t,10))}),i+=1,this._areas[i]=I.imageArea(this,i),e&&this._areas[i].startSelection(e)),i},I.imageSelectAreas.prototype.set=function(e,t,i){this._areas[e]&&(t.id=e,this._areas[e].set(t,i),this._areas[e].focus())},I.imageSelectAreas.prototype._add=function(e,t){var i=this.newArea();this.set(i,e,t)},I.imageSelectAreas.prototype.add=function(e){var i=this;this.blurAll(),I.isArray(e)?I.each(e,function(e,t){i._add(t)}):this._add(e),this._refresh(),this.options.allowSelect||this.options.allowMove||this.options.allowResize||this.options.allowDelete||this.blurAll()},I.imageSelectAreas.prototype.reset=function(){var i=this;this._eachArea(function(e,t){i.remove(t)}),this._refresh()},I.imageSelectAreas.prototype.destroy=function(){this.reset(),this.$holder.remove(),this.$overlay.remove(),this.$trigger.remove(),this.$image.css("width","").css("position","").unwrap(),this.$image.removeData("mainImageSelectAreas")},I.imageSelectAreas.prototype.areas=function(){var t=[];return this._eachArea(function(e){t.push(e.getData())}),t},I.imageSelectAreas.prototype.relativeAreas=function(){function e(e){return Math.floor(e/a)}for(var t=this.areas(),i=[],a=this.ratio,o=0;o<t.length;o++)i[o]=I.extend({},t[o]),i[o].x=e(i[o].x),i[o].y=e(i[o].y),i[o].width=e(i[o].width),i[o].height=e(i[o].height);return i},I.imageSelectAreas.prototype.blurAll=function(){this._eachArea(function(e){e.blur()})},I.imageSelectAreas.prototype.contains=function(t){var i=!1;return this._eachArea(function(e){if(e.contains(t))return!(i=!0)}),i},I.imageSelectAreas.prototype.focus=function(e){this._areas[e]&&this._areas[e].focus()},I.selectAreas=function(e,t){var i=I(e);if(!i.data("mainImageSelectAreas")){var a=new I.imageSelectAreas;a.init(e,t),i.data("mainImageSelectAreas",a),i.trigger("loaded")}return i.data("mainImageSelectAreas")},I.fn.selectAreas=function(i){if(I.imageSelectAreas.prototype[i]){var e=I.imageSelectAreas.prototype[i].apply(I.selectAreas(this),Array.prototype.slice.call(arguments,1));return void 0===e?this:e}if("object"==typeof i||!i)return this.each(function(){var e=this,t=new Image;t.onload=function(){I.selectAreas(e,i)},t.src=e.src}),this;I.error("Method "+i+" does not exist on jQuery.selectAreas")}}(jQuery);